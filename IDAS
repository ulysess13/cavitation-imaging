function [IDAS_Image,max_Intensity] = IDAS_PCI(display,RF_Arr,element_Pos_Array_um_X,expose_time,speed_Of_Sound_umps,sampling_Freq,image_Range_X_um,image_Range_Z_um)
%IDAS_PCI:Instant Delay and sum reconstruction for passive cavitation imaging 
%beamformed_Image: double
%RF_Arr:Rf signal (signal length*channel number)
%element_Pos_Array_um_X: receive transducer element position (x)
%expose_time:expouse time for receive
%speed_Of_Sound_umps: speed of sound in us
%sampling_Freq: sampling frequency Fs
%image_Range_X_um: Pixel matrix width (x)
%image_Range_Z_um: Pixel matrix depth (z)
max_Intensity=zeros(ceil(expose_time*1e6)+1,1);
IDAS_Image = zeros(length(image_Range_X_um), length(image_Range_Z_um));
beamformed_Image = zeros(length(image_Range_X_um), length(image_Range_Z_um));
S = size(RF_Arr);
N=S(1);
for Recon_Start_Time=1:1:expose_time*1e6
    
    for Xi = 1:length(image_Range_X_um)    
        for Zi=1:length(image_Range_Z_um)
            %Calculate sum of intensity at each element for this pixel
            pixel_Amp = 0;
            for ex = 1:length(element_Pos_Array_um_X)
                distance_Along_RF = sqrt((image_Range_X_um(Xi)-element_Pos_Array_um_X(ex))^2+(image_Range_Z_um(Zi))^2);
                time_Pt_Along_RF = distance_Along_RF/(speed_Of_Sound_umps);
                sample_Pt = round((time_Pt_Along_RF+Recon_Start_Time*1e-6)*sampling_Freq);
                if(sample_Pt>N || sample_Pt<1)
                    RF_Amp = 0;
                else
                    RF_Amp = RF_Arr(sample_Pt, ex);
                end
                pixel_Amp = pixel_Amp + RF_Amp;
            end
            beamformed_Image(Xi, Zi) = pixel_Amp;
        end
    end
    
    beamformed_Image_e=envelope(beamformed_Image');
    if display==1
        h=figure(2);set(h,'position',[100,250,512,696])
        imagesc(image_Range_X_um*1e-3, image_Range_Z_um*1e-3, beamformed_Image_e),colormap('hot'),xlabel('lateral/mm'),ylabel('axial/mm')
        title(['Recon start time ' num2str(Recon_Start_Time) ' us']),colorbar('EastOutside');
        pause(0.05);        
    end
    
    max_Intensity(Recon_Start_Time)=max(beamformed_Image_e(:));
    if max_Intensity(Recon_Start_Time)==max(max_Intensity)
        IDAS_Image=beamformed_Image;
    end    
end
end
